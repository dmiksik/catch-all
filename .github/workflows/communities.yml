name: Build communities report

on:
  workflow_dispatch: {}
  schedule:
    - cron: "12 6 * * *"   # denně 06:12 UTC

permissions:
  contents: write     # kvůli commit/push do main
  pages: write        # kvůli Pages deploy
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests markdown

      - name: Run script (generates nrp_by_community.md)
        run: |
          python communities.py

      - name: Commit report to main (only if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add nrp_by_community.md || true
          if ! git diff --cached --quiet; then
            git commit -m "Update report: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Build static HTML (no pandoc)
        run: |
          python - << 'PY'
          import pathlib, markdown, datetime
          md = pathlib.Path("nrp_by_community.md").read_text(encoding="utf-8")
          body = markdown.markdown(md, extensions=["tables"])
          now = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          html_out = f"""<!doctype html>
          <html lang="cs">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>NRP Communities report</title>
            <style>
              :root {{
                --bg: #ffffff; --fg: #1f2937; --muted: #6b7280; --link: #2563eb;
                --border: #e5e7eb; --stripe: #fafafa;
              }}
              @media (prefers-color-scheme: dark) {{
                :root {{
                  --bg: #0b0f14; --fg: #e5e7eb; --muted: #9ca3af; --link: #60a5fa;
                  --border: #1f2937; --stripe: #0f141b;
                }}
              }}
              html,body{{background:var(--bg);color:var(--fg);margin:0;
                font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
                line-height:1.55}}
              .wrap{{max-width:1100px;margin:2rem auto;padding:0 1rem}}
              h1{{margin:0 0 .5rem}}
              .meta{{color:var(--muted);margin:.25rem 0 1.25rem}}
              a{{color:var(--link);text-decoration:none}} a:hover{{text-decoration:underline}}
              table{{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;font-size:.95rem}}
              thead th{{text-align:left;background:var(--stripe);border-bottom:1px solid var(--border);padding:.75rem .85rem;font-weight:600}}
              tbody td{{border-bottom:1px solid var(--border);padding:.65rem .85rem;vertical-align:top}}
              tbody tr:nth-child(even) td{{background:color-mix(in srgb, var(--stripe) 60%, transparent)}}
              td:last-child a{{word-break:break-word}}
              code{{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}}
              .footer{{margin-top:2rem;color:var(--muted);font-size:.9rem}}
            </style>
          </head>
          <body>
            <main class="wrap">
              <h1>NRP Communities report</h1>
              <div class="meta">Publikováno: {now}</div>
              {body}
              <p class="footer">Generováno GitHub Actions z <code>nrp_by_community.md</code>.</p>
            </main>
          </body>
          </html>"""
          out = pathlib.Path("public"); out.mkdir(exist_ok=True)
          (out / "index.html").write_text(html_out, encoding="utf-8")
          PY

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact (site)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  publish-wiki:
    needs: build-and-commit
    runs-on: ubuntu-latest
    permissions:
      contents: write   # potřebujeme push do .wiki repozitáře
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
  
      - name: Checkout wiki repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          ref: master                 # 🔹 ujisti se, že pracujeme na master (Wiki)
          token: ${{ secrets.GITHUB_TOKEN }}
  
      - name: Copy report into wiki
        run: |
          set -euo pipefail
          # název wiki stránky – stabilní a s ASCII pomlčkou
          PAGE="Catch-all Communities.md"
          cp -f nrp_by_community.md "wiki/${PAGE}"
  
          # vytvoř domovskou stránku s odkazem (jen pokud neexistuje)
          if [ ! -f wiki/Home.md ]; then
            printf "# Home\n\n* [[Catch-all Communities]]\n" > wiki/Home.md
          fi
  
      - name: Commit & push wiki
        run: |
          set -euo pipefail
          cd wiki
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Update NRP Communities report (from Actions)"
            git push origin master      # 🔹 explicitně push na master
          else
            echo "No wiki changes to commit."
          fi

  deploy:
    needs: build-and-commit
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
